# Demo: Custom Claude Commands
# This workflow shows how to create different trigger phrases for different actions

name: Claude Commands

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # /fix - Claude will attempt to fix the issue and create a PR
  fix-command:
    if: |
      (github.event_name == 'issue_comment' && 
       !github.event.issue.pull_request &&
       contains(github.event.comment.body, '/fix'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          allowed_tools: |
            mcp__github__create_branch
            mcp__github__create_pull_request
            mcp__github__push_files
            mcp__github__add_issue_comment
            Bash(git *)
            Bash(npm *)
            Read
            Edit
            Write
            Glob
            Grep
          prompt: |
            # /fix Command - Issue Resolution Mode
            
            Read .github/CLAUDE.md for instructions, then:
            
            1. Analyze issue #${{ github.event.issue.number }} thoroughly
            2. Explore the codebase to understand the problem
            3. Implement a fix following project conventions
            4. Run tests with `npm test` and lint with `npm run lint`
            5. Create a branch: `fix/issue-${{ github.event.issue.number }}`
            6. Create a PR that references this issue
            7. Comment on this issue with a summary of your fix
            
            Be thorough but focused. Only change what's necessary.

  # /review - Claude will review code (for PRs only)
  review-command:
    if: |
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/review')) ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '/review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          allowed_tools: |
            Read
            Glob
            Grep
            mcp__github__pull_request_read
            mcp__github__pull_request_review_write
            mcp__github__add_comment_to_pending_review
          prompt: |
            # /review Command - Code Review Mode
            
            Read .github/CLAUDE.md for review guidelines, then:
            
            1. Get the PR diff and changed files
            2. Review for:
               - [SECURITY] Security vulnerabilities
               - [CODE] Code quality and patterns
               - [TYPES] TypeScript correctness
               - [PERF] Performance issues
               - [TEST] Test coverage
            3. Create a thorough review with inline comments
            4. Summarize your findings
            5. Recommend: APPROVE, REQUEST_CHANGES, or COMMENT
            
            Be constructive and specific. Explain the "why" behind suggestions.

  # /explain - Claude will explain the code (read-only)
  explain-command:
    if: |
      contains(github.event.comment.body, '/explain')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          allowed_tools: |
            Read
            Glob
            Grep
            mcp__github__add_issue_comment
          prompt: |
            # /explain Command - Code Explanation Mode
            
            You are in READ-ONLY explanation mode. Do NOT make any changes.
            
            1. Read the issue/PR and any specific questions
            2. Explore the relevant code
            3. Provide a clear, educational explanation:
               - What the code does
               - How it works
               - Why it's designed this way
               - Any potential improvements (as suggestions only)
            
            Use code snippets and diagrams (mermaid) where helpful.
            Target your explanation to the asker's apparent skill level.

  # /help - Show available commands
  help-command:
    if: |
      contains(github.event.comment.body, '/help')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          allowed_tools: |
            mcp__github__add_issue_comment
          prompt: |
            Post a comment listing available Claude commands:
            
            ## ðŸ¤– Claude Commands
            
            | Command | Description | Where |
            |---------|-------------|-------|
            | `@claude` | General assistance - Claude will help based on context | Issues, PRs |
            | `/fix` | Analyze issue and create a PR with the fix | Issues only |
            | `/review` | Perform detailed code review | PRs only |
            | `/explain` | Explain how code works (read-only) | Issues, PRs |
            | `/help` | Show this help message | Anywhere |
            
            ### Tips
            - Be specific in your requests
            - For `/fix`, ensure the issue has clear requirements
            - For `/review`, mention specific areas of concern
            - For `/explain`, ask about specific files or functions
