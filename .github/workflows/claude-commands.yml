# Custom Claude Commands - Automation Mode
# These use 'prompt' for specific tasks, with 'track_progress: true' for comments

name: Claude Commands

on:
  issue_comment:
    types: [created]

jobs:
  # /fix - Claude will attempt to fix the issue and create a PR
  fix-command:
    if: |
      github.event_name == 'issue_comment' && 
      !github.event.issue.pull_request &&
      contains(github.event.comment.body, '/fix')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
      actions: read
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "/fix"
          track_progress: true  # Enable progress comments in automation mode
          claude_args: |
            --model claude-sonnet-4-20250514
          prompt: |
            You received a /fix command on issue #${{ github.event.issue.number }}.
            
            Your task:
            1. Read the issue thoroughly
            2. Analyze the codebase to understand the problem
            3. Implement a fix following project conventions in CLAUDE.md
            4. Run `npm run lint` and `npm test` to verify
            5. Create a branch named `fix/issue-${{ github.event.issue.number }}`
            6. Commit and push your changes
            7. Create a PR that references this issue with "Fixes #${{ github.event.issue.number }}"

  # /review - Code review for PRs
  review-command:
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/review')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "/review"
          track_progress: true
          claude_args: |
            --model claude-sonnet-4-20250514
          prompt: |
            You received a /review command. Perform a thorough code review.
            
            Check for:
            - [SECURITY] Security vulnerabilities
            - [CODE] Code quality and patterns
            - [TYPES] TypeScript correctness  
            - [PERF] Performance issues
            - [TEST] Test coverage
            
            Provide constructive feedback with specific file:line references.
            Recommend: APPROVE, REQUEST_CHANGES, or COMMENT.

  # /explain - Code explanation (read-only)
  explain-command:
    if: contains(github.event.comment.body, '/explain')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "/explain"
          track_progress: true
          prompt: |
            You received an /explain command. Provide a clear explanation.
            
            DO NOT make any code changes - this is read-only.
            
            Explain:
            - What the relevant code does
            - How it works
            - Why it's designed this way
            
            Use code snippets where helpful.

  # /help - Show available commands  
  help-command:
    if: contains(github.event.comment.body, '/help')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "/help"
          track_progress: true
          prompt: |
            Post a comment with this help information:
            
            ## ðŸ¤– Claude Commands
            
            | Command | Description | Where |
            |---------|-------------|-------|
            | `@claude` | General assistance | Issues, PRs |
            | `/fix` | Analyze and fix an issue | Issues only |
            | `/review` | Detailed code review | PRs only |
            | `/explain` | Explain code (read-only) | Anywhere |
            | `/help` | Show this help | Anywhere |
