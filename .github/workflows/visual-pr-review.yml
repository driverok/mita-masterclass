# Claude PR Review Commands
# Two commands for PR review:
# - @claude /review - Code review with detailed findings
# - @claude /visual - Visual QA on Vercel preview with Playwright MCP

name: Claude PR Review

on:
  issue_comment:
    types: [created]

jobs:
  # ============================================
  # @claude /review - Code Review
  # ============================================
  code-review:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude') &&
      contains(github.event.comment.body, '/review')
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          prompt: |
            # Code Review for PR #${{ github.event.issue.number }}

            First, read .github/CLAUDE.md for review guidelines.

            ## Your Task
            Perform a thorough code review of this pull request.

            1. Read the PR diff and changed files
            2. Review for these categories (in priority order):
               - **[SECURITY]** - Exposed secrets, input validation, XSS, auth bypass
               - **[ERROR]** - Graceful failures, error messages, error boundaries
               - **[TYPES]** - TypeScript types, no `any`, proper interfaces
               - **[TESTS]** - New code has tests, existing tests pass
               - **[PERF]** - N+1 queries, unnecessary re-renders, memory leaks
               - **[A11Y]** - Accessibility: labels, keyboard nav, ARIA

            3. Post a summary comment with this format:

            ## Code Review Summary

            ### Files Reviewed
            [List of files with brief notes]

            ### Findings
            [For each category, list findings or "No issues found"]

            ### Verdict: [APPROVE | REQUEST_CHANGES | COMMENT]

            Be constructive and specific. Explain the "why" behind suggestions.

  # ============================================
  # @claude /visual - Visual QA on Vercel Preview
  # ============================================
  # NOTE: Requires Vercel deployment protection to be DISABLED for preview URLs
  # Go to Vercel Project Settings > Deployment Protection > Disable for Preview
  visual-review:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude') &&
      contains(github.event.comment.body, '/visual')
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for Vercel Preview
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.2
        id: wait-for-vercel
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 600
          check_interval: 15

      - name: Run Claude Visual QA
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          claude_args: |
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}'
          prompt: |
            # Visual QA Review for PR #${{ github.event.issue.number }}

            You are a QA engineer performing visual testing on a Vercel preview deployment.

            **Preview URL:** ${{ steps.wait-for-vercel.outputs.url }}

            ## Step 1: Login to the Application

            1. Navigate to ${{ steps.wait-for-vercel.outputs.url }}/login
            2. Wait for the page to load
            3. Use browser_snapshot to see the login form
            4. Type "demo" in the username field (id="username")
            5. Type "demo123" in the password field (id="password")
            6. Click the "Sign in" button
            7. Wait for redirect to /issues page

            ## Step 2: Screenshot Dashboard at 3 Viewports

            Take screenshots of the /issues dashboard at three viewport sizes:
            - Desktop: 1280x720
            - Tablet: 768x1024
            - Mobile: 375x667

            ## Step 3: Post Visual QA Report

            Post a comment with findings for each viewport, issues found, and recommendation (APPROVE/REQUEST_CHANGES/COMMENT).
