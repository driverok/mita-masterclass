name: Claude Visual PR Review

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  visual-review:
    # Run on PR events OR when @claude is mentioned in PR comments
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Vercel Preview URL
        id: vercel
        run: |
          # Wait for Vercel deployment to be ready
          sleep 60
          # Get preview URL from Vercel
          echo "preview_url=https://mita-git-claude-issue-9-20260106-1450-alehs-projects-e24f2cd1.vercel.app" >> $GITHUB_OUTPUT

      - name: Create screenshots directory
        run: mkdir -p ./screenshots

      - name: Run Claude Visual Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: "--model claude-sonnet-4-20250514"
          prompt: |
            First, read .github/CLAUDE.md for CI/CD specific instructions and follow them.

            You are reviewing PR #${{ github.event.pull_request.number }} for the MITA issue tracker app.
            
            Vercel Preview URL: ${{ steps.vercel.outputs.preview_url }}
            
            ## VISUAL REVIEW WITH PLAYWRIGHT
            
            Use the Playwright MCP server to take screenshots at different viewports.
            
            1. **Desktop View (1280px width)**:
               - Navigate to the Vercel preview URL
               - Take a screenshot
               
            2. **Tablet View (768px width)**:
               - Resize viewport to 768px
               - Take a screenshot
               
            3. **Mobile View (375px width)**:
               - Resize viewport to 375px
               - Take a screenshot
            
            For each viewport, check:
            - Does the IssueCard component render correctly?
            - Are there any layout issues or overflow?
            - Do the badges and buttons display properly?
            
            ## REPORT FORMAT
            
            ### Visual Review Results
            - Include the screenshots you captured
            - For each viewport, describe what you observed
            - Tag issues with [VISUAL]
            
            ### Summary
            - Pass/Fail for each viewport
            - Overall recommendation

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-review-screenshots
          path: ./screenshots/
          retention-days: 7
