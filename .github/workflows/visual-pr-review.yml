name: Claude Visual PR Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  visual-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Vercel Preview URL
        id: vercel
        run: |
          # Wait for Vercel deployment to be ready
          echo "Waiting 90 seconds for Vercel deployment..."
          sleep 90
          echo "preview_url=https://mita-git-claude-issue-9-20260106-1450-alehs-projects-e24f2cd1.vercel.app" >> $GITHUB_OUTPUT

      - name: Run Claude Visual Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: |
            --model claude-sonnet-4-20250514
            --mcp-config '{"mcpServers": {"playwright": {"command": "npx", "args": ["-y", "@anthropic-ai/mcp-server-playwright", "--screenshot-path", "./screenshots"]}}}'
            --allowedTools mcp__playwright__browser_navigate mcp__playwright__browser_screenshot mcp__playwright__browser_resize
          prompt: |
            You are reviewing PR #${{ github.event.pull_request.number }} for the MITA issue tracker app.
            
            ## YOUR TASK: VISUAL REVIEW WITH SCREENSHOTS
            
            Use the Playwright MCP tools to take screenshots of the Vercel preview at different viewports.
            
            Preview URL: ${{ steps.vercel.outputs.preview_url }}
            
            ### Steps:
            
            1. **Desktop View (1280x800)**:
               - Use browser_navigate to go to the preview URL
               - Use browser_screenshot to capture the page
               - Describe what you see
               
            2. **Tablet View (768x1024)**:
               - Use browser_resize to change viewport to 768x1024
               - Use browser_screenshot to capture the page
               - Describe what you see
               
            3. **Mobile View (375x667)**:
               - Use browser_resize to change viewport to 375x667
               - Use browser_screenshot to capture the page
               - Describe what you see - check for overflow issues
            
            ### Report Format:
            
            Post your findings as a PR comment with:
            - Screenshot images embedded (if possible) or descriptions
            - ✅ PASS or ❌ FAIL for each viewport
            - Any visual bugs found (overflow, clipping, layout issues)
            - Overall recommendation

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-review-screenshots
          path: ./screenshots/
          retention-days: 7
