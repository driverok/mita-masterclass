# Claude PR Review Commands
# Two commands for PR review:
# - @claude /review - Code review with detailed findings
# - @claude /visual - Visual QA on Vercel preview with Playwright MCP

name: Claude PR Review

on:
  issue_comment:
    types: [created]

jobs:
  # ============================================
  # @claude /review - Code Review
  # ============================================
  code-review:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude') &&
      contains(github.event.comment.body, '/review')
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          allowed_tools: |
            Read
            Glob
            Grep
            mcp__github__pull_request_read
            mcp__github__pull_request_review_write
            mcp__github__add_comment_to_pending_review
            mcp__github__add_issue_comment
          prompt: |
            # Code Review for PR #${{ github.event.issue.number }}

            First, read .github/CLAUDE.md for review guidelines.

            ## Your Task
            Perform a thorough code review of this pull request.

            ### Step 1: Get PR Information
            Use mcp__github__pull_request_read to get:
            - PR diff and changed files
            - PR description and context

            ### Step 2: Review Categories
            Check for issues in these categories (in priority order):
            - **[SECURITY]** - Exposed secrets, input validation, XSS, auth bypass
            - **[ERROR]** - Graceful failures, error messages, error boundaries
            - **[TYPES]** - TypeScript types, no `any`, proper interfaces
            - **[TESTS]** - New code has tests, existing tests pass
            - **[PERF]** - N+1 queries, unnecessary re-renders, memory leaks
            - **[A11Y]** - Accessibility: labels, keyboard nav, ARIA

            ### Step 3: Create Review
            Create inline comments for specific issues using:
            - mcp__github__pull_request_review_write (method: create)
            - mcp__github__add_comment_to_pending_review

            ### Step 4: Post Summary
            Post a summary comment with this format:

            ## Code Review Summary

            ### Files Reviewed
            [List of files with brief notes]

            ### Findings

            #### Security
            - [Finding or "No issues found"]

            #### Error Handling
            - [Finding or "No issues found"]

            #### TypeScript
            - [Finding or "No issues found"]

            #### Tests
            - [Finding or "No issues found"]

            #### Performance
            - [Finding or "No issues found"]

            #### Accessibility
            - [Finding or "No issues found"]

            ### Verdict: [APPROVE | REQUEST_CHANGES | COMMENT]

            Be constructive and specific. Explain the "why" behind suggestions.

  # ============================================
  # @claude /visual - Visual QA on Vercel Preview
  # ============================================
  visual-review:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude') &&
      contains(github.event.comment.body, '/visual')
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for Vercel Preview
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.2
        id: wait-for-vercel
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 600
          check_interval: 15

      - name: Run Claude Visual QA
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          claude_args: |
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}'
          allowed_tools: |
            mcp__playwright__browser_navigate
            mcp__playwright__browser_click
            mcp__playwright__browser_type
            mcp__playwright__browser_take_screenshot
            mcp__playwright__browser_resize
            mcp__playwright__browser_snapshot
            mcp__playwright__browser_wait
            mcp__github__add_issue_comment
          prompt: |
            # Visual QA Review for PR #${{ github.event.issue.number }}

            You are a QA engineer performing visual testing on a Vercel preview deployment.

            **Preview URL:** ${{ steps.wait-for-vercel.outputs.url }}

            ## Step 1: Login to the Application

            1. Navigate to ${{ steps.wait-for-vercel.outputs.url }}/login
            2. Wait for the page to load
            3. Use browser_snapshot to see the login form
            4. Type "demo" in the username field (id="username")
            5. Type "demo123" in the password field (id="password")
            6. Click the "Sign in" button
            7. Wait for redirect to /issues page
            8. Verify you are logged in by checking the page content

            ## Step 2: Screenshot Dashboard at 3 Viewports

            Take screenshots of the /issues dashboard at three viewport sizes:

            **Desktop (1280x720):**
            1. browser_resize to width=1280, height=720
            2. browser_take_screenshot
            3. Note any layout issues

            **Tablet (768x1024):**
            1. browser_resize to width=768, height=1024
            2. browser_take_screenshot
            3. Note responsive behavior

            **Mobile (375x667):**
            1. browser_resize to width=375, height=667
            2. browser_take_screenshot
            3. Note mobile-specific issues

            ## Step 3: Check for Visual Issues

            At each viewport, verify:
            - Elements don't overflow horizontally
            - Text is readable (not badly truncated)
            - Buttons and links are visible and clickable
            - Forms are usable
            - Navigation is accessible
            - Cards and lists display correctly

            ## Step 4: Post Visual QA Report

            Post a comment on the PR with this format:

            ## Visual QA Report

            **Preview URL:** ${{ steps.wait-for-vercel.outputs.url }}
            **Login:** Successful with demo/demo123

            ### Screenshots Captured

            | Viewport | Size | Status |
            |----------|------|--------|
            | Desktop | 1280x720 | [OK/Issues] |
            | Tablet | 768x1024 | [OK/Issues] |
            | Mobile | 375x667 | [OK/Issues] |

            ### Desktop (1280px) Findings
            - [What works / what's broken]

            ### Tablet (768px) Findings
            - [What works / what's broken]

            ### Mobile (375px) Findings
            - [What works / what's broken]

            ### Issues Found
            For each issue:
            - [VISUAL] Description of issue
            - Location: Page/component affected
            - Severity: Critical/High/Medium/Low

            ### Recommendation
            [APPROVE | REQUEST_CHANGES | COMMENT]

            **Important:** Continue testing even if you find issues. Document ALL findings.
