name: Claude Visual QA Review

on:
  # Trigger on label - more controlled than auto-trigger
  pull_request:
    types: [labeled]
  # Also allow manual trigger via comment
  issue_comment:
    types: [created]

jobs:
  visual-qa:
    # Run when 'qa-verify' label added OR '@claude /visual' mentioned
    if: |
      (github.event_name == 'pull_request' &&
       github.event.label.name == 'qa-verify') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude') &&
       contains(github.event.comment.body, '/visual'))
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.head_ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup database
        run: |
          npx prisma generate
          npx prisma db push

      - name: Create artifacts directory
        run: mkdir -p ./qa-artifacts

      - name: Start dev server
        run: |
          npm run dev &
          # Wait for server to be ready
          sleep 15
          # Verify server is running
          curl -s http://localhost:3000 > /dev/null || echo "Server check failed"

      - name: Run Claude Visual QA
        uses: anthropics/claude-code-action@v1
        env:
          QA_ARTIFACTS_DIR: ${{ github.workspace }}/qa-artifacts
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          claude_args: |
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless","--viewport-size=1280x720","--save-trace","--save-session"]}}}'
          allowed_tools: |
            mcp__playwright__browser_navigate
            mcp__playwright__browser_click
            mcp__playwright__browser_type
            mcp__playwright__browser_take_screenshot
            mcp__playwright__browser_resize
            mcp__playwright__browser_snapshot
            mcp__playwright__browser_wait
            Read
            Glob
            Grep
          prompt: |
            First, read .github/CLAUDE.md for CI/CD specific instructions.

            # Visual QA Review for PR #${{ github.event.pull_request.number || github.event.issue.number }}

            You are an AI QA Engineer. Your job is to test the UI through the browser,
            like a real user would. You can only see the UI - not the source code.

            **Test URL:** http://localhost:3000

            ## QA Testing Instructions

            ### 1. Navigate and Test Main Flows
            Navigate to http://localhost:3000 and test these user flows:
            - Login page: Check form layout, input fields, buttons
            - Dashboard: Check issue list display, filtering
            - Issue creation/editing if accessible

            ### 2. Take Screenshots at Each Viewport
            For EACH page you test, capture screenshots:

            **Desktop (1280x720):**
            - Use browser_take_screenshot tool
            - Note: screenshots are saved automatically

            **Tablet (768x1024):**
            - First resize: browser_resize to 768x1024
            - Then screenshot

            **Mobile (375x667):**
            - Resize: browser_resize to 375x667
            - Then screenshot

            ### 3. Check for Issues
            At each viewport, verify:
            - ‚úÖ Elements don't overflow horizontally
            - ‚úÖ Text is readable (not truncated badly)
            - ‚úÖ Buttons/links are clickable
            - ‚úÖ Forms are usable
            - ‚úÖ No console errors visible

            ### 4. Document Everything
            After testing, report:

            ## üì± Visual QA Report

            ### Screenshots Captured
            - List each screenshot taken with description

            ### Desktop (1280px) Findings
            - What works / what's broken

            ### Tablet (768px) Findings
            - What works / what's broken

            ### Mobile (375px) Findings
            - What works / what's broken

            ### Issues Found
            For each issue use format:
            - ‚ùå [VISUAL] Description of issue
            - Location: Page/component affected
            - Severity: Critical/High/Medium/Low

            ### Recommendation
            - APPROVE: No visual issues found
            - REQUEST_CHANGES: Critical issues need fixing
            - COMMENT: Minor issues noted

            **Important:** Continue testing even if you find bugs. Document ALL issues.

      - name: Upload QA Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-qa-artifacts-pr-${{ github.event.pull_request.number || github.event.issue.number }}
          path: |
            ./qa-artifacts/
            ~/.cache/ms-playwright/
          retention-days: 14
          if-no-files-found: warn

      - name: Comment artifact link on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## üì∏ Visual QA Artifacts\n\nScreenshots and traces from this QA run are available as artifacts:\n\nüîó [View Artifacts](${runUrl}#artifacts)\n\nDownload the \`visual-qa-artifacts-pr-${prNumber}\` artifact to review screenshots and Playwright traces.`
            });
